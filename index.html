<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rates and Codes Engine â€” PhilHealth Case Rate Search</title>

<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{/* ignore */});
  }
</script>

<style>
  /* Base Theme (Dark) */
  :root{
    --bg-color:#0d1117;
    --text-color:#c9d1d9;
    --card-bg:#161b22;
    --border-color:#30363d;
    --accent-color:#58a6ff;
    --muted-color:#8b949e;
  }
  body.light{
    --bg-color:#f5f6fa;
    --text-color:#2f3640;
    --card-bg:#ffffff;
    --border-color:#dcdde1;
    --accent-color:#273c75;
    --muted-color:#555;
  }
  html,body{
    height:100%;
    margin:0;
    font-family:"Segoe UI",Arial,Helvetica,sans-serif;
    background:var(--bg-color);
    color:var(--text-color);
    transition:background .3s;
  }
  
  .app-container{
    max-width:900px;
    margin:0 auto;
    padding:20px;
    height:100vh;
    display:flex;
    flex-direction:column;
    gap:15px;
  }

  /* HEADER & UI ELEMENTS */
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding-bottom:10px;
    border-bottom:1px solid var(--border-color);
  }

  .sub-header{
    margin-top:-5px;
    font-size:14px;
    color:var(--muted-color);
  }

  .settings-panel{
    display:flex;
    gap:10px;
    align-items:center;
  }

  .btn{
    padding:8px 14px;
    background:var(--card-bg);
    border:1px solid var(--border-color);
    border-radius:6px;
    cursor:pointer;
    color:var(--text-color);
    transition:background .2s, border-color .2s;
    font-size:16px;
    line-height:1;
  }

  .btn:hover{
    background:var(--border-color);
  }
  
  #colorPicker{
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    width:32px;
    height:32px;
    border:1px solid var(--border-color);
    border-radius:6px;
    padding:0;
    cursor:pointer;
    background:var(--card-bg);
    outline:none;
  }
  #colorPicker::-webkit-color-swatch-wrapper{padding:0;}
  #colorPicker::-webkit-color-swatch{border:none;border-radius:4px;}
  #colorPicker::-moz-color-swatch{border:none;border-radius:4px;}


  /* SEARCH */
  .search-area{
    display:flex;
    gap:10px;
  }

  #searchBar{
    flex-grow:1;
    padding:10px;
    border-radius:6px;
    border:1px solid var(--border-color);
    background:var(--card-bg);
    color:var(--text-color);
    font-size:16px;
    transition:border-color .2s;
  }
  #searchBar:focus{
    border-color:var(--accent-color);
    outline:none;
  }

  /* RESULTS */
  .results-container{
    flex-grow:1;
    overflow-y:auto;
    background:var(--card-bg);
    border:1px solid var(--border-color);
    padding:15px;
    border-radius:8px;
  }

  .result-card{
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:15px;
    margin-bottom:15px;
    transition:border-color .2s;
  }
  .result-card:hover{
    border-color:var(--accent-color);
  }

  .result-card h3{
    margin:0 0 10px 0;
    color:var(--accent-color);
    border-bottom:1px dashed var(--border-color);
    padding-bottom:8px;
  }

  .rate-info{
    display:flex;
    gap:25px;
    flex-wrap:wrap;
    margin-bottom:10px;
    font-size:1.1em;
  }

  .rate-item strong{
    display:block;
    font-size:0.8em;
    color:var(--muted-color);
  }

  /* REQUIREMENTS */
  .requirements-block{
    margin-top:15px;
    border:1px solid var(--border-color);
    padding:12px;
    border-radius:6px;
    background:var(--border-color);
  }

  .requirements-block strong{
    font-size:0.95em;
    color:var(--accent-color);
  }

  .req-reminder{
    margin-top:8px;
    padding:10px;
    background:rgba(255,165,0,0.15); /* Slightly stronger orange background */
    border-left:4px solid orange;
    border-radius:4px;
    font-size:0.9em;
  }

  .req-missing{
    color:var(--muted-color);
    margin-top:8px;
    font-weight:normal;
    font-style:italic;
  }

  .req-check{
    margin-top:6px;
    font-size:0.9em;
  }

  .req-ok{
    color:#57d77a;
  }

  .req-bad{
    color:#ff5555;
  }

  .loading-message{
    text-align:center;
    margin-top:40px;
    color:var(--muted-color);
    font-size:1.2em;
  }
</style>

<script>
let fs = null;
let path = null; // Need path for join
let ipcRenderer = null;
let isElectron = false;
let dbData = [];

// Try to load Electron/Node modules
if (typeof require !== "undefined") {
Â  try {
Â  Â  const electron = require("electron");
Â  Â  ipcRenderer = electron.ipcRenderer;
Â  Â  fs = require("fs");
Â  Â  path = require("path");
Â  Â  isElectron = true;
Â  } catch (e) {
Â  Â  console.warn("Electron/Node modules unavailable:", e.message);
Â  }
}


/* Load database.json (Single Combined File) */
async function loadDatabase() {
Â  const params = new URLSearchParams(window.location.search);
Â  const dbPath = params.get("db_path"); 

Â  try {
Â  Â  if (!isElectron) {
        throw new Error("Not running in Electron environment. Cannot load local database.");
    }
    
    if (!dbPath) {
        throw new Error("Database path (db_path) is missing from URL parameters.");
    }
    
Â  Â  // Check if the file exists using synchronous check (this is fast)
Â  Â  if (!fs.existsSync(dbPath)) {
        throw new Error(`Case Rate Database file not found at: ${dbPath}`);
    }
Â  Â  
    // CRITICAL FIX: Use fs.promises.readFile (async) instead of fs.readFileSync (sync)
    // to prevent freezing the main thread.
    const fileContent = await fs.promises.readFile(dbPath, "utf8");
Â  Â  dbData = JSON.parse(fileContent); 

Â  Â  document.getElementById("loadingText").style.display = "none";
Â  Â  document.getElementById("searchBar").disabled = false;
Â  Â  document.getElementById("searchBtn").disabled = false;
    document.getElementById("searchBar").focus();

Â  } catch (err) {
Â  Â  document.getElementById("resultsContainer").innerHTML =
Â  Â  Â  `<div style="color:#ff5555;padding:20px;">
        <h3 style="color:#ff5555;">Database Load Error</h3>
        <p>Could not load the PhilHealth Case Rate data.</p>
        <pre style="white-space:pre-wrap;word-break:break-all;font-size:0.9em;">${err.message}</pre>
        <p style="font-size:0.9em;">If running in Electron, ensure 'database.json' is correctly bundled and the path is passed to the window URL.</p>
    </div>`;
Â  }
}

/* REQUIREMENTS RENDERER */
function renderRequirements(req) {
Â  // CRITICAL: Check if req is a valid object before proceeding
Â  if (!req || typeof req !== 'object' || Array.isArray(req)) return "";

Â  let html = `<div class="requirements-block"><strong>Requirements & Reminders</strong>`;

Â  // 1. Check for the REMINDER/REQUIREMENTS field (The long text field)
Â  const reminderText = req["REMINDER/REQUIREMENTS"];
Â  if (reminderText) {
Â  Â  const txt = String(reminderText)
Â  Â  Â  .replace(/\\n/g,"<br>")
Â  Â  Â  .replace(/\n/g,"<br>");
Â  Â  html += `<div class="req-reminder">${txt}</div>`;
Â  } else {
Â  Â  html += `<div class="req-missing">No specific reminders found for this code.</div>`;
Â  }

Â  // 2. Check for other requirements (CF3, CF4, XRAY, etc.)
Â  Object.keys(req).forEach(key => {
Â  Â  // Ignore keys that might be metadata or auto-generated indices
Â  Â  if (key.includes("Unnamed") || key === "REMINDER/REQUIREMENTS") return; 

Â  Â  // Assume 1 means required, 0 or null/undefined means not required
Â  Â  const val = Number(req[key]) || 0; 
Â  Â  const statusText = val === 1 ? "âœ”ï¸ Required" : "âŒ Not Required";
Â  Â  const css = val === 1 ? "req-ok" : "req-bad";

Â  Â  html += `<div class="req-check ${css}">${statusText}: ${key}</div>`;
Â  });

Â  html += `</div>`;
Â  return html;
}

/* SEARCH */
function executeSearch() {
Â  const q = document.getElementById("searchBar").value.trim().toLowerCase();
Â  const container = document.getElementById("resultsContainer");
Â  container.innerHTML = "";

Â  if (q.length < 2) {
Â  Â  container.innerHTML =
Â  Â  Â  `<div style="text-align:center;color:var(--muted-color);padding:20px;">Enter at least 2 characters to search by ICD Code or Description.</div>`;
Â  Â  return;
Â  }

Â  const results = dbData.filter(item =>
Â  Â  String(item.code || "").toLowerCase().includes(q) ||
Â  Â  String(item.description || "").toLowerCase().includes(q)
Â  );

Â  if (results.length === 0) {
Â  Â  container.innerHTML =
Â  Â  Â  `<div style="text-align:center;color:var(--muted-color);padding:20px;">No results found for "${q}".</div>`;
Â  Â  return;
Â  }

Â  results.slice(0, 50).forEach(item => {
Â  Â  const card = document.createElement("div");
Â  Â  card.classList.add("result-card");

Â  Â  // Access the requirements object directly
Â  Â  const req = item.requirements || null; 
    
    // Currency Formatting (Fixed: ensures â‚± is added once)
    const formatRate = (value) => `â‚±${(Number(value) || 0).toLocaleString()}`;

Â  Â  card.innerHTML = `
Â  Â  Â  <h3>[${item.code || 'N/A'}] ${item.description || 'No Description'}</h3>

Â  Â  Â  <div class="rate-info">
Â  Â  Â  Â  <div class="rate-item"><strong>Case Rate</strong>${formatRate(item.rate)}</div>
Â  Â  Â  Â  <div class="rate-item"><strong>Facility</strong>${formatRate(item.facility)}</div>
Â  Â  Â  Â  <div class="rate-item"><strong>Professional</strong>${formatRate(item.professional)}</div>
Â  Â  Â  </div>

Â  Â  Â  ${renderRequirements(req)}
Â  Â  `;

Â  Â  container.appendChild(card);
Â  });
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
Â  loadDatabase();

Â  // Search setup
Â  document.getElementById("searchBar").addEventListener('input', executeSearch);
Â  document.getElementById("searchBtn").onclick = executeSearch;

Â  // Theme and Accent Color setup
Â  const themeToggle = document.getElementById("themeToggle");
Â  const colorPicker = document.getElementById("colorPicker");
  
Â  function applyTheme(mode) {
Â  Â  document.body.classList.toggle("light", mode === "light");
Â  Â  themeToggle.textContent = mode === "light" ? "ğŸŒ™" : "â˜€ï¸";
    localStorage.setItem("race_theme", mode);
Â  };
Â  function applyAccent(c) {
    document.documentElement.style.setProperty("--accent-color", c);
    localStorage.setItem("race_accent", c);
    colorPicker.value = c;
Â  }
  
Â  // Load saved preferences
Â  applyTheme(localStorage.getItem("race_theme") || "dark");
  applyAccent(localStorage.getItem("race_accent") || "#58a6ff");

Â  themeToggle.onclick = () => {
Â  Â  const nextMode = document.body.classList.contains("light") ? "dark" : "light";
Â  Â  applyTheme(nextMode);
Â  };
  colorPicker.oninput = (e) => applyAccent(e.target.value);


Â  // Calculator button
Â  document.getElementById("calcShortcut").onclick = () => {
Â  Â  window.open("https://www.calculator.net/date-calculator.html", "_blank");
Â  };

Â  // ALT + SHIFT + C shortcut
Â  document.addEventListener("keydown", e => {
Â  Â  if (e.altKey && e.shiftKey && (e.key === "c" || e.key === "C")) {
Â  Â  Â  window.open("https://www.calculator.net/date-calculator.html", "_blank");
Â  Â  }
Â  });

Â  // Close window (Electron/Browser)
Â  document.getElementById("closeBtn").onclick = () => {
Â  Â  if (isElectron && ipcRenderer) ipcRenderer.send("app-close");
Â  Â  else window.close();
Â  };
});
</script>
</head>

<body>
<div class="app-container">

Â  <div class="header">
Â  Â  <div>
Â  Â  Â  <h2 style="margin:0;">RACE 2025 Search</h2>
Â  Â  Â  <div class="sub-header">PhilHealth Case Rate Search</div>
Â  Â  </div>

Â  Â  <div class="settings-panel">
Â  Â  Â  <button id="calcShortcut" class="btn" title="Open Date Calculator (Alt+Shift+C)">ğŸ“…</button>
Â  Â  Â  <input type="color" id="colorPicker" value="#58a6ff" title="Change Accent Color">
Â  Â  Â  <button id="themeToggle" class="btn" title="Toggle Light/Dark Theme">â˜€ï¸</button>
Â  Â  Â  <button id="closeBtn" class="btn" title="Close Window">âŒ</button>
Â  Â  </div>
Â  </div>

Â  <div class="search-area">
Â  Â  <input type="text" id="searchBar" placeholder="Enter ICD Code or Description..." disabled>
Â  Â  <button id="searchBtn" class="btn" disabled>Search</button>
Â  </div>

Â  <div id="resultsContainer" class="results-container">
Â  Â  <p id="loadingText" class="loading-message">Loading Database...</p>
Â  </div>

</div>
</body>
</html>
